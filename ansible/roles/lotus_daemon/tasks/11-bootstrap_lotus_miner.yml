---
- name: Read Lotus Miner API token from file
  ansible.builtin.shell:
    cmd: "cat {{ lotus_miner_api_token_file }}"
  register: lotus_miner_api_token
  become_user: "{{ lotus_user }}"
  become: true
  changed_when: false
  ignore_errors: true
  when: lotus_miner_api_token_file is defined

- name: If we successfully read a Lotus Miner API token, flatten the variable.
  set_fact:
    lotus_miner_api_token: "{{ lotus_miner_api_token.stdout }}"
  when: lotus_miner_api_token.stdout != "" and lotus_miner_api_token.rc == 0

- name: Create Lotus Miner API token if we don't have one or if we have an invalid one
  block:
    - name: Create Lotus Miner API token
      ansible.builtin.shell:
        cmd: "lotus-miner auth create-token --perm admin"
      register: new_miner_api_token
      become_user: "{{ lotus_user }}"
      become: true

    - name: Print API token
      debug:
        msg: "API token: {{ new_miner_api_token.stdout }}"

    - name: Store API token as a variable if we retrieved it successfully
      set_fact:
        lotus_miner_api_token: "{{ new_miner_api_token.stdout }}"
      when: 
        - new_miner_api_token is defined
        - new_miner_api_token.stdout | length > 0
        - new_miner_api_token.rc == 0

    - name: Write API token to file if we retrieved it successfully
      ansible.builtin.copy:
        content: "{{ new_miner_api_token.stdout }}"
        dest: "{{ lotus_miner_api_token_file }}"
        owner: "{{ lotus_user }}"
        group: "{{ lotus_group }}"
        mode: '0400'
      when: 
        - new_miner_api_token is defined
        - new_miner_api_token.stdout | length > 0
        - new_miner_api_token.rc == 0
  
    # Re-read the Lotus Miner API token now that we have created it
    - name: Read Lotus Miner API token from file
      ansible.builtin.shell:
        cmd: "cat {{ lotus_miner_api_token_file }}"
      register: lotus_miner_api_token
      become_user: "{{ lotus_user }}"
      become: true
      changed_when: false
      ignore_errors: true
      when: lotus_miner_api_token_file is defined
  # We run all these tasks if we are unable to find a seemingly valid API token.
  when: lotus_miner_api_token.stdout == "" or lotus_miner_api_token.rc != 0

- name: Set miner_api_info
  set_fact:
    miner_api_info: "{{ lotus_miner_api_token }}:/ip4/${MINER_IP}/tcp/${MINER_PORT}/http"
